<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>stringsnthingsV6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #f9f9f9;
      font-family: sans-serif;
    }
    #canvas {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: auto;
      transform-origin: 0 0;
      background: #f0f0f0;
    }
    .box {
      position: absolute;
      background: white;
      border: 2px solid #aaa;
      border-radius: 10px;
      padding: 10px;
      resize: both;
      overflow: hidden;
      min-width: 100px;
      min-height: 60px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
    }
    .box textarea {
      width: 100%;
      height: 100%;
      border: none;
      resize: none;
      background: transparent;
      outline: none;
      font-size: 16px;
      font-family: inherit;
    }
    .box .toolbar {
      position: absolute;
      top: 5px;
      right: 5px;
      display: flex;
      gap: 5px;
    }
    .toolbar button {
      border: none;
      background: #eee;
      cursor: pointer;
      padding: 2px 5px;
      border-radius: 5px;
    }
    svg {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
    }
    #bottomBar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #ddd;
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 5px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="canvas"></div>
  <svg id="svg"></svg>
  <div id="bottomBar">
    <button onclick="toggleDrawMode()">Toggle Connect Mode</button>
    <button onclick="markCenter()">Mark Center</button>
    <button onclick="goToCenter()">Go to Center</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD94o-k4pxwvDY4D2mJfn8Wj6LTzBh0ppM",
      authDomain: "stringsnthings-65aa0.firebaseapp.com",
      projectId: "stringsnthings-65aa0",
      storageBucket: "stringsnthings-65aa0.appspot.com",
      messagingSenderId: "465795346204",
      appId: "1:465795346204:web:4b0029cd687f5f6f2645bc"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ✅ Sign in anonymously so Firestore rules allow saving
    firebase.auth().signInAnonymously().catch(console.error);

    const canvas = document.getElementById("canvas");
    const svg = document.getElementById("svg");
    let drawMode = false;
    let connectFrom = null;
    let centerCoords = null;
    let undoStack = [];

    canvas.addEventListener("dblclick", (e) => {
      const x = e.pageX;
      const y = e.pageY;
      createBox(x, y);
    });

    function createBox(x, y, text = "", id = null, w = 150, h = 100) {
      if (!id) id = "box_" + Date.now();
      const box = document.createElement("div");
      box.className = "box";
      box.style.left = x + "px";
      box.style.top = y + "px";
      box.style.width = w + "px";
      box.style.height = h + "px";
      box.setAttribute("data-id", id);

      const toolbar = document.createElement("div");
      toolbar.className = "toolbar";

      const del = document.createElement("button");
      del.textContent = "X";
      del.onclick = () => {
        undoStack.push({type: 'delete', box});
        deleteBox(id, box);
      };
      toolbar.appendChild(del);

      const connect = document.createElement("button");
      connect.textContent = "⭯";
      connect.onclick = () => {
        if (connectFrom && connectFrom !== id) {
          connectBoxes(connectFrom, id);
          connectFrom = null;
        } else if (connectFrom === id) {
          connectFrom = null;
        } else {
          connectFrom = id;
        }
      };
      toolbar.appendChild(connect);

      box.appendChild(toolbar);

      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.oninput = () => saveBox(id, box);
      box.appendChild(textarea);

      makeDraggable(box);
      makeResizable(box);

      canvas.appendChild(box);
      saveBox(id, box);
    }

    function deleteBox(id, box) {
      db.collection("boxes").doc(id).delete();
      db.collection("connections").where("from", "==", id).get().then(snap => {
        snap.forEach(doc => doc.ref.delete());
      });
      db.collection("connections").where("to", "==", id).get().then(snap => {
        snap.forEach(doc => doc.ref.delete());
      });
      box.remove();
      drawConnections();
    }

    function connectBoxes(fromId, toId) {
      const connRef = db.collection("connections");
      connRef.where("from", "==", fromId).where("to", "==", toId).get().then(snapshot => {
        if (!snapshot.empty) {
          snapshot.forEach(doc => doc.ref.delete());
        } else {
          connRef.add({ from: fromId, to: toId });
        }
        drawConnections();
      });
    }

    function makeDraggable(el) {
      let offsetX, offsetY;
      el.onmousedown = (e) => {
        if (e.target.tagName === "TEXTAREA" || e.target.tagName === "BUTTON") return;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
        function move(ev) {
          el.style.left = (ev.pageX - offsetX) + "px";
          el.style.top = (ev.pageY - offsetY) + "px";
          saveBox(el.dataset.id, el);
          drawConnections();
        }
        function up() {
          document.removeEventListener("mousemove", move);
          document.removeEventListener("mouseup", up);
        }
        document.addEventListener("mousemove", move);
        document.addEventListener("mouseup", up);
      };
    }

    function makeResizable(el) {
      const ro = new ResizeObserver(() => {
        autoFont(el.querySelector("textarea"));
        saveBox(el.dataset.id, el);
        drawConnections();
      });
      ro.observe(el);
    }

    function autoFont(textarea) {
      const size = Math.max(12, Math.min(32, Math.min(textarea.clientWidth, textarea.clientHeight) / 5));
      textarea.style.fontSize = size + "px";
    }

    function saveBox(id, el) {
      const data = {
        x: parseInt(el.style.left),
        y: parseInt(el.style.top),
        w: parseInt(el.style.width),
        h: parseInt(el.style.height),
        text: el.querySelector("textarea").value
      };
      db.collection("boxes").doc(id).set(data).catch(e => console.error("Error saving box:", e));
    }

    function loadAll() {
      db.collection("boxes").get().then(snapshot => {
        snapshot.forEach(doc => {
          const d = doc.data();
          createBox(d.x, d.y, d.text, doc.id, d.w, d.h);
        });
      });
      db.collection("connections").onSnapshot(snapshot => {
        connections = [];
        snapshot.forEach(doc => connections.push(doc.data()));
        drawConnections();
      });
    }

    function drawConnections() {
      svg.innerHTML = "";
      db.collection("connections").get().then(snapshot => {
        snapshot.forEach(doc => {
          const { from, to } = doc.data();
          const box1 = document.querySelector(`[data-id="${from}"]`);
          const box2 = document.querySelector(`[data-id="${to}"]`);
          if (box1 && box2) {
            const x1 = box1.offsetLeft + box1.offsetWidth / 2;
            const y1 = box1.offsetTop + box1.offsetHeight / 2;
            const x2 = box2.offsetLeft + box2.offsetWidth / 2;
            const y2 = box2.offsetTop + box2.offsetHeight / 2;
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", `M${x1},${y1} C${x1+100},${y1} ${x2-100},${y2} ${x2},${y2}`);
            path.setAttribute("stroke", "#333");
            path.setAttribute("stroke-width", "2");
            path.setAttribute("fill", "none");
            svg.appendChild(path);
          }
        });
      });
    }

    function toggleDrawMode() {
      drawMode = !drawMode;
    }

    function markCenter() {
      centerCoords = {
        x: canvas.scrollLeft,
        y: canvas.scrollTop
      };
    }

    function goToCenter() {
      if (centerCoords) {
        canvas.scrollTo(centerCoords.x, centerCoords.y);
      }
    }

    loadAll();
  </script>
</body>
</html>
