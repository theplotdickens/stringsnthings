<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Strings N Things</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
html, body {margin:0; height:100%; overflow:hidden; font-family: monospace, monospace; touch-action:none;}
#viewport {width:100%; height:100%; position:relative; background:#f0f0f0; cursor:grab; overflow:hidden; box-sizing:border-box;}
#canvas {position:absolute; top:0; left:0; width:10000px; height:10000px; transform-origin:0 0; z-index:10;}
.box {position:absolute; background:white; border:1px solid black; min-width:80px; min-height:40px; user-select:none; box-sizing:border-box; display:flex; flex-direction:column; cursor:text; overflow:hidden; transition: width 0.1s ease, height 0.1s ease;}
.box.selected {outline:2px dashed blue;}
.box-header {background:#ddd; padding-left:24px; min-width:40px; min-height:18px; height:18px; box-sizing:border-box; display:flex; justify-content:flex-end; align-items:center; gap:4px; position:relative; user-select:none; cursor:default; border-bottom:1px solid #bbb; font-size:12px; flex-shrink:0;}
.drag-handle {position:absolute; left:4px; top:50%; transform:translateY(-50%); font-size:14px; cursor:move; user-select:none; width:16px; height:16px; display:flex; align-items:center; justify-content:center; color:#333; white-space:nowrap; z-index:5;}
.delete-btn {color:red; font-weight:bold; cursor:pointer; font-size:14px; line-height:1; user-select:none; padding:0; margin:0; border:none; background:transparent; width:18px; height:18px; display:flex; align-items:center; justify-content:center;}
.connect-toggle {width:10px; height:10px; border-radius:50%; border:none; background-color:blue; cursor:pointer; user-select:none; transition: background-color 0.25s ease; padding:0; margin:0; flex-shrink:0;}
.connect-toggle.active {background-color:green;}
.font-size-btn {font-size:14px; width:18px; height:18px; line-height:1; cursor:pointer; user-select:none; background:transparent; border:none; color:black; padding:0; margin:0 2px; display:flex; align-items:center; justify-content:center;}
.box-content {flex:1; padding:2px; white-space:pre-wrap; font-family:monospace, monospace; overflow-wrap:break-word; outline:none; cursor:text; user-select:text; line-height:1.1; min-height:24px; box-sizing:border-box; resize:none; display:flex; justify-content:center; align-items:center; text-align:center; word-break:break-word;}
.resize-handle {width:16px; height:16px; background:transparent; position:absolute; z-index:20; touch-action:none;}
.resize-handle.nw {top:-8px; left:-8px; cursor:nwse-resize;}
.resize-handle.ne {top:-8px; right:-8px; cursor:nesw-resize;}
.resize-handle.sw {bottom:-8px; left:-8px; cursor:nesw-resize;}
.resize-handle.se {bottom:-8px; right:-8px; cursor:nwse-resize;}
#topMenu {position:fixed; top:8px; left:50%; transform:translateX(-50%); background:rgba(240,240,240,0.95); border:1px solid #bbb; border-radius:6px; padding:6px 12px; display:flex; align-items:center; gap:12px; font-family:monospace; z-index:10000; box-shadow:0 0 8px rgba(0,0,0,0.1); user-select:none;}
#mapSelect {font-family:monospace; font-size:14px; padding:2px 4px; border-radius:4px; border:1px solid #888; cursor:pointer; min-width:150px;}
#saveMapBtn, #renameMapBtn, #deleteMapBtn, #newMapBtn {background:#555; color:#eee; border:none; border-radius:4px; padding:4px 10px; cursor:pointer; font-family:monospace; font-size:14px; user-select:none; transition:background-color 0.2s ease;}
#saveMapBtn:hover, #renameMapBtn:hover, #deleteMapBtn:hover, #newMapBtn:hover {background:#333;}
#saveStatus {font-size:13px; color:green; min-width:90px; user-select:none;}
#buttonContainer {position:fixed; bottom:12px; left:50%; transform:translateX(-50%); display:flex; gap:12px; z-index:1000; user-select:none;}
.floatingBtn {background:rgba(100,100,100,0.5); color:#eee; font-family:monospace, monospace; font-size:16px; padding:6px 12px; border:1px solid #555; border-radius:4px; cursor:pointer; min-width:100px; text-align:center; box-shadow:0 0 6px rgba(0,0,0,0.3); touch-action:manipulation; transition:background 0.2s ease;}
.floatingBtn:active {background:rgba(80,80,80,0.7);}
.floatingBtn:disabled {background:rgba(150,150,150,0.3); cursor:default; color:#999; border-color:#999; box-shadow:none;}
#zoomDisplay {position:fixed; bottom:60px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.5); color:white; font-family:monospace; padding:4px 8px; border-radius:4px; user-select:none; pointer-events:none; z-index:1001;}
#connectionLayer {position:absolute; top:0; left:0; width:10000px; height:10000px; pointer-events:none; z-index:1; transform-origin:0 0;}
#footerInfo {position:fixed; bottom:60px; left:50%; transform:translateX(-50%); font-family:monospace, monospace; font-size:14px; color:#555; user-select:none; z-index:1002; background:rgba(255,255,255,0.9); padding:4px 8px; border-radius:4px; box-shadow:0 0 5px rgba(0,0,0,0.1); pointer-events:none; width:max-content; max-width:90vw; text-align:center;}
.marquee {position:absolute; border:2px dashed #00f; background:rgba(0,0,255,0.1); display:none; z-index:9999;}
</style>
</head>
<body>
<div id="topMenu">
  <select id="mapSelect" title="Select a mind map"></select>
  <button id="saveMapBtn" title="Save current mind map">Save</button>
  <button id="renameMapBtn" title="Rename current mind map">Rename</button>
  <button id="deleteMapBtn" title="Delete current mind map">Delete</button>
  <button id="newMapBtn" title="Create new mind map">New Map</button>
  <div id="saveStatus"></div>
</div>

<div id="viewport" tabindex="0">
  <svg id="connectionLayer" width="10000" height="10000"></svg>
  <div id="canvas"></div>
  <div class="marquee" id="marquee"></div>
</div>

<div id="buttonContainer">
  <button id="undoBtn" class="floatingBtn" disabled>Undo Delete</button>
  <button id="goCenterBtn" class="floatingBtn">Go to Center</button>
  <button id="markCenterBtn" class="floatingBtn">Mark Center</button>
  <button id="toggleEditModeBtn" class="floatingBtn">Toggle Edit Mode</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCpp42OH-1mTZxu5iq44dmMQc8ahQdvnL0",
  authDomain: "stringsnthings-65aa0.firebaseapp.com",
  projectId: "stringsnthings-65aa0",
  storageBucket: "stringsnthings-65aa0.appspot.com",
  messagingSenderId: "35780192306",
  appId: "1:35780192306:web:80aedf9baea2ffac0cf42b"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const canvas = document.getElementById('canvas');
const viewport = document.getElementById('viewport');
const undoBtn = document.getElementById('undoBtn');
const goCenterBtn = document.getElementById('goCenterBtn');
const markCenterBtn = document.getElementById('markCenterBtn');
const toggleEditModeBtn = document.getElementById('toggleEditModeBtn');
const mapSelect = document.getElementById('mapSelect');
const saveMapBtn = document.getElementById('saveMapBtn');
const renameMapBtn = document.getElementById('renameMapBtn');
const deleteMapBtn = document.getElementById('deleteMapBtn');
const newMapBtn = document.getElementById('newMapBtn');
const saveStatus = document.getElementById('saveStatus');
const connectionLayer = document.getElementById('connectionLayer');
const marquee = document.getElementById('marquee');

let scale = 1, panX = 0, panY = 0;
let isPanning = false, startX, startY;
let marqueeStart = null;
let marqueeSelecting = false;

const undoStack = [];
const connections = [];
const boxesMap = new Map();
let editMode = true;
let connectionStartBoxId = null;
const selectedBoxes = new Set();
let currentMapId = null;
let mapsCache = new Map();
let markedCenter = null;

// Utils
function getClientCoords(e){if(e.touches)return {x:e.touches[0].clientX, y:e.touches[0].clientY}; return {x:e.clientX, y:e.clientY};}
function generateId(){return 'id-'+Math.random().toString(36).slice(2,11);}
function updateTransform(){canvas.style.transform=`translate(${panX}px,${panY}px) scale(${scale})`; connectionLayer.style.transform=`translate(${panX}px,${panY}px) scale(${scale})`; drawConnections();}

// Marquee selection functions
viewport.addEventListener('contextmenu', e=>e.preventDefault());
viewport.addEventListener('mousedown', e=>{
  if(e.button===2){ // right click
    e.preventDefault();
    marqueeStart = getClientCoords(e);
    marquee.style.left = marqueeStart.x+'px';
    marquee.style.top = marqueeStart.y+'px';
    marquee.style.width='0px';
    marquee.style.height='0px';
    marquee.style.display='block';
    marqueeSelecting = true;
  }
});
viewport.addEventListener('mousemove', e=>{
  if(!marqueeSelecting) return;
  const coords=getClientCoords(e);
  const x=Math.min(coords.x, marqueeStart.x);
  const y=Math.min(coords.y, marqueeStart.y);
  const w=Math.abs(coords.x-marqueeStart.x);
  const h=Math.abs(coords.y-marqueeStart.y);
  marquee.style.left=x+'px';
  marquee.style.top=y+'px';
  marquee.style.width=w+'px';
  marquee.style.height=h+'px';
});
viewport.addEventListener('mouseup', e=>{
  if(!marqueeSelecting) return;
  selectedBoxes.forEach(b=>b.classList.remove('selected'));
  selectedBoxes.clear();
  const rect=marquee.getBoundingClientRect();
  boxesMap.forEach(box=>{
    const bRect=box.getBoundingClientRect();
    if(bRect.right>=rect.left && bRect.left<=rect.right && bRect.bottom>=rect.top && bRect.top<=rect.bottom){
      selectedBoxes.add(box);
      box.classList.add('selected');
    }
  });
  marquee.style.display='none';
  marqueeSelecting=false;
});

// Panning with left click
viewport.addEventListener('mousedown', e=>{
  if(e.button!==0) return;
  if(e.target.closest('.box-header')||e.target.closest('.drag-handle')||e.target.closest('.resize-handle')||e.target.closest('.floatingBtn')||e.target.closest('#mapSelect')) return;
  isPanning=true;
  const coords=getClientCoords(e);
  startX=coords.x; startY=coords.y;
  viewport.setPointerCapture(e.pointerId);
});
viewport.addEventListener('mousemove', e=>{
  if(!isPanning) return;
  const coords=getClientCoords(e);
  panX+=coords.x-startX; panY+=coords.y-startY;
  startX=coords.x; startY=coords.y;
  updateTransform();
});
viewport.addEventListener('mouseup', e=>{isPanning=false; viewport.releasePointerCapture(e.pointerId);});

// Zoom with wheel
viewport.addEventListener('wheel', e=>{
  e.preventDefault();
  const zoomFactor=1.1;
  const dir=e.deltaY>0?1/zoomFactor:zoomFactor;
  let newScale=scale*dir;
  newScale=Math.min(3, Math.max(0.5, newScale));
  const rect=viewport.getBoundingClientRect();
  const mx=e.clientX-rect.left, my=e.clientY-rect.top;
  panX=mx-(mx-panX)*(newScale/scale);
  panY=my-(my-panY)*(newScale/scale);
  scale=newScale;
  updateTransform();
},{passive:false});

// Box creation
function createBox(id,x,y,w=120,h=60,text='',fontSize=14){
  if(boxesMap.has(id)) return;
  const box=document.createElement('div'); box.classList.add('box');
  box.style.left=x+'px'; box.style.top=y+'px'; box.style.width=w+'px'; box.style.height=h+'px';
  box.dataset.id=id; box.style.fontSize=fontSize+'px';
  const header=document.createElement('div'); header.classList.add('box-header'); header.style.display=editMode?'flex':'none';
  const dragHandle=document.createElement('div'); dragHandle.classList.add('drag-handle'); dragHandle.textContent='✥';
  header.appendChild(dragHandle);
  const connectToggle=document.createElement('button'); connectToggle.classList.add('connect-toggle');
  connectToggle.addEventListener('click', e=>{
    e.stopPropagation();
    connectToggle.classList.toggle('active');
    if(connectToggle.classList.contains('active')){
      if(connectionStartBoxId&&connectionStartBoxId!==id){addConnection(connectionStartBoxId,id); clearConnectionSelection();}
      else connectionStartBoxId=id;
    } else{if(connectionStartBoxId===id)connectionStartBoxId=null;}
    drawConnections();
  });
  header.appendChild(connectToggle);
  const fontDecrease=document.createElement('button'); fontDecrease.classList.add('font-size-btn'); fontDecrease.textContent='−';
  fontDecrease.addEventListener('click', e=>{e.stopPropagation(); let s=parseInt(box.style.fontSize)||fontSize; s=Math.max(8,s-1); box.style.fontSize=s+'px';});
  header.appendChild(fontDecrease);
  const fontIncrease=document.createElement('button'); fontIncrease.classList.add('font-size-btn'); fontIncrease.textContent='+';
  fontIncrease.addEventListener('click', e=>{e.stopPropagation(); let s=parseInt(box.style.fontSize)||fontSize; s=Math.min(40,s+1); box.style.fontSize=s+'px';});
  header.appendChild(fontIncrease);
  const deleteBtn=document.createElement('button'); deleteBtn.classList.add('delete-btn'); deleteBtn.textContent='×';
  deleteBtn.addEventListener('click', e=>{e.stopPropagation(); deleteBox(id);});
  header.appendChild(deleteBtn);
  box.appendChild(header);
  const content=document.createElement('div'); content.classList.add('box-content'); content.contentEditable=editMode; content.spellcheck=false;
  content.textContent=text; content.style.userSelect=editMode?'text':'none'; box.appendChild(content);
  ['nw','ne','sw','se'].forEach(pos=>{const handle=document.createElement('div'); handle.classList.add('resize-handle',pos); box.appendChild(handle); handle.addEventListener('pointerdown', resizePointerDown);});
  dragHandle.addEventListener('pointerdown', dragPointerDown);
  header.addEventListener('click', e=>{
    if(!editMode) return;
    e.stopPropagation();
    if(e.shiftKey){if(selectedBoxes.has(box)){selectedBoxes.delete(box); box.classList.remove('selected');} else {selectedBoxes.add(box); box.classList.add('selected');}}
    else{selectedBoxes.forEach(b=>b.classList.remove('selected')); selectedBoxes.clear(); selectedBoxes.add(box); box.classList.add('selected');}
  });
  canvas.appendChild(box); boxesMap.set(id,box); drawConnections();
}

// Drag selected boxes
let dragState=null;
function dragPointerDown(e){
  if(!editMode) return; e.stopPropagation(); e.preventDefault();
  const box=e.target.closest('.box'); if(!box) return;
  dragState={boxesToMove:selectedBoxes.has(box)?Array.from(selectedBoxes):[box], startX:e.clientX, startY:e.clientY, origPositions:[]};
  dragState.boxesToMove.forEach(b=>dragState.origPositions.push({box:b, left:parseFloat(b.style.left), top:parseFloat(b.style.top)}));
  window.addEventListener('pointermove', dragPointerMove); window.addEventListener('pointerup', dragPointerUp);
}
function dragPointerMove(e){
  if(!dragState) return; e.preventDefault();
  const dx=(e.clientX-dragState.startX)/scale, dy=(e.clientY-dragState.startY)/scale;
  dragState.origPositions.forEach(p=>{p.box.style.left=p.left+dx+'px'; p.box.style.top=p.top+dy+'px';});
  drawConnections();
}
function dragPointerUp(e){dragState=null; window.removeEventListener('pointermove', dragPointerMove); window.removeEventListener('pointerup', dragPointerUp);}

// Resize
let resizeState=null;
function resizePointerDown(e){
  e.stopPropagation(); e.preventDefault();
  const box=e.target.closest('.box'); if(!box) return;
  const pos=e.target.classList.contains('nw')?'nw':e.target.classList.contains('ne')?'ne':e.target.classList.contains('sw')?'sw':'se';
  resizeState={box,pos,startX:e.clientX,startY:e.clientY,startW:parseFloat(box.style.width),startH:parseFloat(box.style.height),startLeft:parseFloat(box.style.left),startTop:parseFloat(box.style.top)};
  window.addEventListener('pointermove', resizePointerMove); window.addEventListener('pointerup', resizePointerUp);
}
function resizePointerMove(e){
  if(!resizeState) return; const dx=(e.clientX-resizeState.startX)/scale; const dy=(e.clientY-resizeState.startY)/scale;
  let w=resizeState.startW, h=resizeState.startH, left=resizeState.startLeft, top=resizeState.startTop;
  if(resizeState.pos.includes('e')) w=resizeState.startW+dx;
  if(resizeState.pos.includes('s')) h=resizeState.startH+dy;
  if(resizeState.pos.includes('w')){w=resizeState.startW-dx; left=resizeState.startLeft+dx;}
  if(resizeState.pos.includes('n')){h=resizeState.startH-dy; top=resizeState.startTop+dy;}
  w=Math.max(40,w); h=Math.max(24,h);
  resizeState.box.style.width=w+'px'; resizeState.box.style.height=h+'px'; resizeState.box.style.left=left+'px'; resizeState.box.style.top=top+'px';
  drawConnections();
}
function resizePointerUp(e){resizeState=null; window.removeEventListener('pointermove', resizePointerMove); window.removeEventListener('pointerup', resizePointerUp);}

// Connections
function addConnection(fromId,toId){connections.push({from:fromId,to:toId}); drawConnections();}
function clearConnectionSelection(){connectionStartBoxId=null;}
function drawConnections(){
  connectionLayer.innerHTML=''; connections.forEach(conn=>{
    const fromBox=boxesMap.get(conn.from); const toBox=boxesMap.get(conn.to); if(!fromBox||!toBox) return;
    const fx=parseFloat(fromBox.style.left)+fromBox.offsetWidth/2;
    const fy=parseFloat(fromBox.style.top)+fromBox.offsetHeight/2;
    const tx=parseFloat(toBox.style.left)+toBox.offsetWidth/2;
    const ty=parseFloat(toBox.style.top)+toBox.offsetHeight/2;
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',fx); line.setAttribute('y1',fy); line.setAttribute('x2',tx); line.setAttribute('y2',ty); line.setAttribute('stroke','black'); line.setAttribute('stroke-width','2'); connectionLayer.appendChild(line);
  });
}

// Box deletion
function deleteBox(id){const box=boxesMap.get(id); if(!box) return; undoStack.push({id:id,html:box.outerHTML}); box.remove(); boxesMap.delete(id); drawConnections(); undoBtn.disabled=false;}
undoBtn.addEventListener('click', ()=>{
  if(!undoStack.length) return;
  const last=undoStack.pop();
  canvas.insertAdjacentHTML('beforeend',last.html);
  const box=document.getElementById(last.id) || canvas.lastElementChild;
  boxesMap.set(last.id,box);
  undoBtn.disabled=!undoStack.length;
  drawConnections();
});

// Centering
goCenterBtn.addEventListener('click', ()=>{panX=viewport.clientWidth/2-5000*scale; panY=viewport.clientHeight/2-5000*scale; updateTransform();});
markCenterBtn.addEventListener('click', ()=>{markedCenter={x:panX,y:panY};});

// Edit mode toggle
toggleEditModeBtn.addEventListener('click', ()=>{
  editMode=!editMode;
  boxesMap.forEach(box=>{box.querySelector('.box-header').style.display=editMode?'flex':'none'; box.querySelector('.box-content').contentEditable=editMode;});
});

// Firebase map functions
async function loadMaps(){
  mapSelect.innerHTML='';
  const colSnap=await getDocs(collection(db,'maps'));
  colSnap.forEach(docSnap=>{
    const opt=document.createElement('option');
    opt.value=docSnap.id; opt.textContent=docSnap.data().name || docSnap.id; mapSelect.appendChild(opt);
    mapsCache.set(docSnap.id,docSnap.data());
  });
  if(mapSelect.options.length>0){mapSelect.selectedIndex=0; loadMap(mapSelect.value);}
}
async function loadMap(id){
  currentMapId=id;
  canvas.innerHTML=''; connections.length=0; boxesMap.clear();
  const docSnap=await getDoc(doc(db,'maps',id));
  if(!docSnap.exists()) return;
  const data=docSnap.data();
  (data.boxes||[]).forEach(b=>createBox(b.id,b.x,b.y,b.w,b.h,b.text,b.fontSize));
  (data.connections||[]).forEach(c=>addConnection(c.from,c.to));
}
saveMapBtn.addEventListener('click', async ()=>{
  if(!currentMapId) return;
  const boxes=[], conns=[];
  boxesMap.forEach(box=>boxes.push({id:box.dataset.id,x:parseFloat(box.style.left),y:parseFloat(box.style.top),w:parseFloat(box.style.width),h:parseFloat(box.style.height),text:box.querySelector('.box-content').textContent,fontSize:parseInt(box.style.fontSize)||14}));
  connections.forEach(c=>conns.push(c));
  await setDoc(doc(db,'maps',currentMapId),{boxes:boxes,connections:conns,name:mapsCache.get(currentMapId)?.name||currentMapId});
  saveStatus.textContent='Saved'; setTimeout(()=>saveStatus.textContent='',1500);
});
mapSelect.addEventListener('change', ()=>{loadMap(mapSelect.value);});
newMapBtn.addEventListener('click', async ()=>{
  const name=prompt('Enter new map name:'); if(!name) return;
  const id=generateId(); await setDoc(doc(db,'maps',id),{boxes:[],connections:[],name:name});
  await loadMaps(); mapSelect.value=id; loadMap(id);
});
renameMapBtn.addEventListener('click', async ()=>{
  if(!currentMapId) return;
  const newName=prompt('Enter new map name:'); if(!newName) return;
  const data=mapsCache.get(currentMapId)||{}; data.name=newName; await setDoc(doc(db,'maps',currentMapId),data); await loadMaps(); mapSelect.value=currentMapId;
});
deleteMapBtn.addEventListener('click', async ()=>{
  if(!currentMapId) return; if(!confirm('Delete this map?')) return;
  await deleteDoc(doc(db,'maps',currentMapId)); await loadMaps();
});

loadMaps();
updateTransform();
</script>
</body>
</html>
