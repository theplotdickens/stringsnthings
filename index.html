<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>stringsnthings Simple</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  html, body { margin:0; height:100%; overflow:hidden; font-family: monospace; }
  #viewport { position:relative; width:100%; height:100%; background:#f8f8f8; user-select:none; }
  #canvas { position:absolute; top:0; left:0; width:100%; height:100%; }
  .box {
    position:absolute; background:#fff; border:1px solid #333; min-width:100px; min-height:50px;
    display:flex; flex-direction: column; box-sizing: border-box; user-select:text;
  }
  .box-header {
    background:#ddd; padding:2px 4px; display:flex; justify-content:flex-end; gap:4px; user-select:none;
  }
  .btn {
    cursor:pointer; border:none; background:none; font-weight:bold; font-size:16px; width:20px; height:20px;
    line-height:18px; padding:0; color:#333;
  }
  .btn:hover { color:red; }
  .connect-toggle {
    width:20px; height:20px; background:#3a7bd5; border-radius:50%; cursor:pointer; border:none;
  }
  .connect-toggle.active { background:#32a852; }
  .box-content {
    flex:1; padding:6px 8px; outline:none; overflow:auto; font-size:14px; white-space: pre-wrap;
    word-break: break-word;
  }
  svg#connections {
    position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1;
  }
</style>
</head>
<body>
  <div id="viewport">
    <svg id="connections"></svg>
    <div id="canvas"></div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script>
  // Firebase config (fill with your keys)
  const firebaseConfig = {
    apiKey: "AIzaSyCpp42OH-1mTZxu5iq44dmMQc8ahQdvnL0",
    authDomain: "stringsnthings-65aa0.firebaseapp.com",
    projectId: "stringsnthings-65aa0",
    storageBucket: "stringsnthings-65aa0.appspot.com",
    messagingSenderId: "35780192306",
    appId: "1:35780192306:web:80aedf9ba9e2ffac0cf42b"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const canvas = document.getElementById('canvas');
  const connectionsSVG = document.getElementById('connections');

  let boxes = {};
  let connections = [];
  let connectionMode = null; // {fromBoxId}

  // Utility to create unique IDs for boxes
  function createId() {
    return 'box_' + Date.now() + '_' + Math.floor(Math.random()*10000);
  }

  // Create box DOM and attach events
  function createBox(id, x, y, text='New box') {
    if (boxes[id]) return; // already exists

    const box = document.createElement('div');
    box.className = 'box';
    box.style.left = x + 'px';
    box.style.top = y + 'px';
    box.style.width = '160px';
    box.style.height = '80px';
    box.dataset.id = id;

    // Header with buttons
    const header = document.createElement('div');
    header.className = 'box-header';

    const connectBtn = document.createElement('button');
    connectBtn.className = 'connect-toggle btn';
    connectBtn.title = 'Connect';
    header.appendChild(connectBtn);

    const delBtn = document.createElement('button');
    delBtn.className = 'btn';
    delBtn.title = 'Delete';
    delBtn.textContent = 'Ã—';
    header.appendChild(delBtn);

    // Content editable area
    const content = document.createElement('div');
    content.className = 'box-content';
    content.contentEditable = true;
    content.textContent = text;

    box.appendChild(header);
    box.appendChild(content);
    canvas.appendChild(box);

    // Drag variables
    let drag = { active:false, offsetX:0, offsetY:0 };

    header.style.cursor = 'move';

    // Drag handlers
    header.addEventListener('mousedown', e => {
      e.preventDefault();
      drag.active = true;
      drag.offsetX = e.clientX - box.offsetLeft;
      drag.offsetY = e.clientY - box.offsetTop;
    });
    document.addEventListener('mouseup', e => {
      if (drag.active) {
        drag.active = false;
        saveBox(id);
        drawConnections();
      }
    });
    document.addEventListener('mousemove', e => {
      if (!drag.active) return;
      let newX = e.clientX - drag.offsetX;
      let newY = e.clientY - drag.offsetY;
      newX = Math.max(0, newX);
      newY = Math.max(0, newY);
      box.style.left = newX + 'px';
      box.style.top = newY + 'px';
      drawConnections();
    });

    // Delete button
    delBtn.addEventListener('click', async () => {
      await deleteBox(id);
    });

    // Connect toggle
    connectBtn.addEventListener('click', () => {
      if (connectionMode && connectionMode.fromBoxId === id) {
        connectionMode = null;
        connectBtn.classList.remove('active');
      } else {
        // deactivate all others
        document.querySelectorAll('.connect-toggle').forEach(b => b.classList.remove('active'));
        connectBtn.classList.add('active');
        connectionMode = {fromBoxId: id};
      }
    });

    // Clicking another box while connectionMode is active adds a connection
    box.addEventListener('click', async (e) => {
      if (!connectionMode) return;
      if (connectionMode.fromBoxId === id) return;
      // Add connection
      connections.push({from: connectionMode.fromBoxId, to: id});
      connectionMode = null;
      document.querySelectorAll('.connect-toggle').forEach(b => b.classList.remove('active'));
      await saveConnections();
      drawConnections();
    });

    // Save content edits after short delay
    let saveTimeout = null;
    content.addEventListener('input', () => {
      if(saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => saveBox(id), 500);
    });

    boxes[id] = { box, content };

    return box;
  }

  // Save box data to Firestore
  async function saveBox(id) {
    const { box, content } = boxes[id];
    const data = {
      x: parseInt(box.style.left),
      y: parseInt(box.style.top),
      text: content.textContent
    };
    await db.collection('boxes').doc(id).set(data);
  }

  // Delete box and related connections
  async function deleteBox(id) {
    // Remove box DOM
    const { box } = boxes[id];
    box.remove();
    delete boxes[id];

    // Remove connections with this box
    connections = connections.filter(c => c.from !== id && c.to !== id);

    // Delete from Firestore
    await db.collection('boxes').doc(id).delete();

    // Delete connections with this box
    const batch = db.batch();
    const connsSnap = await db.collection('connections').where('from', '==', id).get();
    connsSnap.forEach(doc => batch.delete(doc.ref));
    const connsSnap2 = await db.collection('connections').where('to', '==', id).get();
    connsSnap2.forEach(doc => batch.delete(doc.ref));
    await batch.commit();

    await saveConnections();
    drawConnections();
  }

  // Save all connections to Firestore (clears and re-adds)
  async function saveConnections() {
    // Clear all
    const snap = await db.collection('connections').get();
    const batch = db.batch();
    snap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();

    // Add current
    for (const conn of connections) {
      await db.collection('connections').add(conn);
    }
  }

  // Draw connections as SVG lines
  function drawConnections() {
    connectionsSVG.innerHTML = '';
    connections.forEach(({from, to}) => {
      const fromBox = boxes[from];
      const toBox = boxes[to];
      if (!fromBox || !toBox) return;

      const start = getBoxCenter(fromBox.box);
      const end = getBoxCenter(toBox.box);

      // Draw simple curved path
      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      const dx = end.x - start.x;
      const dy = end.y - start.y;
      const qx = start.x + dx/2;
      const qy = start.y;

      path.setAttribute('d', `M${start.x},${start.y} Q${qx},${qy} ${end.x},${end.y}`);
      path.setAttribute('stroke', '#000');
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke-width', '2');
      path.style.pointerEvents = 'stroke';

      // Clicking path deletes connection
      path.style.cursor = 'pointer';
      path.addEventListener('click', async () => {
        connections = connections.filter(c => !(c.from === from && c.to === to));
        await saveConnections();
        drawConnections();
      });

      connectionsSVG.appendChild(path);
    });
  }

  function getBoxCenter(box) {
    const rect = box.getBoundingClientRect();
    const canvasRect = canvas.getBoundingClientRect();
    return {
      x: rect.left - canvasRect.left + rect.width/2,
      y: rect.top - canvasRect.top + rect.height/2
    };
  }

  // Load boxes from Firestore and create them
  async function loadBoxes() {
    const snapshot = await db.collection('boxes').get();
    snapshot.forEach(doc => {
      const data = doc.data();
      createBox(doc.id, data.x, data.y, data.text);
    });
  }

  // Load connections from Firestore
  async function loadConnections() {
    const snapshot = await db.collection('connections').get();
    connections = [];
    snapshot.forEach(doc => connections.push(doc.data()));
  }

  // Double click to create box at mouse position
  canvas.addEventListener('dblclick', e => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const id = createId();
    createBox(id, x, y, '');
    saveBox(id);
  });

  // Initialize app
  (async () => {
    await loadBoxes();
    await loadConnections();
    drawConnections();
  })();
</script>
</body>
</html>
